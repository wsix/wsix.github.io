---
title: "【自动驾驶】 Kalman Filter 推导流程简述"
categories:
  - technology
tags:
  - self-driving car
---

在 Udacity 的自动驾驶工程师第二学期的课程上学习了 Kalman Filter 和 Extended Kalman Filter 的使用，但是里面并没有详细的推导过程。在课下自己搜集资料整理了一下，在这里做一下记录。

### Kalman Filter 在自动驾驶中的应用场景

CarND 中提到，行人或者车辆位置的观察序列可以通过 Radar 或者 Laser 实时获得，但是在现实世界中，通过这些途径获得的数据往往包含噪声，因此不能直接用于判断行人或车辆的坐标和速度。此时就要 Kalman Filter 大展身手了。卡尔曼滤波可以利用目标的动态信息，设法去掉噪声的影响，得到一个关于目标位置的好的估计。

### 基本动态系统模型

Kalman Filter 模型假设 k 时刻的真实状态是从（k − 1）时刻的状态演化而来，符合下式：

$$
x_k = A x_{k-1} + B u_k + w_k
$$

其中

* **$ \{x_k, x_{k-1}\} $**是状态向量，包含了观测的目标；
* **$ \{u_k\} $**是驱动输入向量，如物体在运动过程中受力产生的加速度；
* **$ \{A\} $**是状态转移矩阵，其隐含指示了“k-1 时刻的物体状态会影响 k 时刻的物体状态”；
* **$ \{B\} $**是控制输入矩阵，其隐含了“k-1 时刻给的驱动如何影响 k 时刻的状态”；
* **$ \{w_k\} $**是过程噪声，$ \{w \sim N(0 , Q)\} $的高斯分布。

而在 k 时刻，对于真实状态$ \{x_k\} $的一个测量值$ \{z_k\} $满足下式：

$$
z_k = H x_k + v_k
$$

其中

* **$ \{H\} $**是观测模型，它把真实状态空间映射成观测空间；
* **$ \{v_k\} $**是观测噪声，$ \{v \sim N(0 , R)\} $。

### 推导过程

用上面的两个公式，我们可以分别得到对于 k 时刻的物体真实状态的预测值(Prediction)和测量值(Measurement)。那么我们如何使用这两个值得到最优的估计值呢？答案就是反馈。

现在我们假设$ \{\hat{x}^{\'}_k\} $是预测值，$ \{\hat{z}_k\} $是根据预测值得到的测量值的预测值，$ \{\hat{x}_k\} $是最终的估计值。由一般的反馈思想我们可以得到如下式子：

$$
\hat{x}_k = \hat{x}^{'}_k + K_k (z_k - \hat{z}_k) \\
= \hat{x}^{'}_k + K_k (z_k - H \hat{x}^{'}_k)
$$

其中，$ \{(z_k - H \hat{x}^{'}_k)\} $ 被称为残差，即预测值和真实值之间的差距。如果这项等于0，说明预测值和实际测量值完全相同。接下来就是求取这个 K 的值了。具体的方法[这篇文章](http://blog.csdn.net/heyijia0327/article/details/17487467)里作者已经说明的很详细了，下面在这里说明一下具体思路:

1. 求估计值与真实值之间的协方差$ \{P_k\} $和估计值与预测值之间的协方差$ \{P^{\'}_k\} $；

    $$
    P_k = E[(x_k - \hat{x}_k)(x_k - \hat{x}_k)^T] \\
    P^{'}_k = E[(x_k - \hat{x}^{'}_k)(x_k - \hat{x}^{'}_k)^T]
    $$

    将$ \{\hat{x}_k\} $公式代入$ \{P_k\} $化简可得：

    $$
    P_k = (I - K_k H) P^{'}_k (I - K_k H)^T + K_k R K^T_k
    $$

2. 求均方差，即求$ \{P_k\} $的迹，可得：

    $$
    T[P_k] = T[P^{'}_k] - 2T[K_k H P^{'}_k] + T[K_k (H P^{'}_k H^T + R) K^T_k]
    $$

3. 最小化均方差，即令$ \{T[P_k]\} $的导数为零，可得：

    $$
    K_k = P^{'}_k H^T (H P^{'}_k H^T + R)^{-1}
    $$

4. 将这个结果反代入之前的$ \{P_k\} $的表达式中，便可以得到$ \{P_k\} $的递推公式了：

    $$
    P_k = (I - K_k H) P^{'}_k
    $$

### 使用 Kalman Filter 的递推过程

下面总结一下使用 Kalman Filter 的递推过程：

↑→↓  首先，计算预测值，预测值和真实值之间的协方差矩阵

↑　↓  　**预测值**：$ \{\hat{x}^{\'}_k=A \hat{x}\_{k-1} + B u\_{k-1}\} $

↑　↓  　**预-真协方差**：$ \{P^{\'}_k = A P\_{k-1} A^T + Q\} $

↑　↓  接着，计算卡尔曼增益 K，根据测量值计算得到估计值：

↑　↓  　**卡尔曼增益**：$ \{K_k = P^{\'}\_k H^T (H P^{\'}\_k H^T + R)^{-1}\} $

↑　↓  　**估计值**：$ \{\hat{x}_k = \hat{x}^{\'}\_k + K\_k(z\_k - H \hat{x}^{\'}\_k)\} $

↑　↓  最后，计算估计值与真实值之间的协方差矩阵，为下次递推做准备：

↑←↓  　**估-真协方差**：$ \{P_k = (I - K\_k H) P^{\'}\_k\} $





